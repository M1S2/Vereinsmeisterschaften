<UserControl x:Class="Vereinsmeisterschaften.Controls.MultiSelectComboBox"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:Vereinsmeisterschaften.Converters"
             x:Name="root">
    <UserControl.Resources>
        <converters:SelectedItemsContainsConverter x:Key="SelectedItemsContainsConverter" />
    </UserControl.Resources>

    <Grid>
        <Border x:Name="PART_ComboBoxContent" BorderThickness="1" BorderBrush="{DynamicResource MahApps.Brushes.ComboBox.Border.Focus}" CornerRadius="3"
                Background="{DynamicResource MahApps.Brushes.ComboBox.Background}" Padding="2"
                MinHeight="24" VerticalAlignment="Center"
                PreviewMouseLeftButtonUp="OnTogglePopup" MouseEnter="PART_ComboBoxContent_MouseEnter" MouseLeave="PART_ComboBoxContent_MouseLeave">
            <DockPanel LastChildFill="True">
                <Path DockPanel.Dock="Right" Margin="5,0" Width="12" Height="8" Fill="{DynamicResource MahApps.Brushes.Text}" VerticalAlignment="Center">
                    <Path.Style>
                        <Style TargetType="{x:Type Path}">
                            <!-- Arrow Down -->
                            <Setter Property="Data" Value="M 0 0 L 12 0 L 6 8 Z"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPopupOpen, ElementName=root}" Value="True">
                                    <!-- Arrow Up -->
                                    <Setter Property="Data" Value="M 6 0 L 12 8 L 0 8 Z"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Path.Style>
                </Path>

                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding SelectedItems, ElementName=root}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource MahApps.Brushes.Gray2}" CornerRadius="10" Margin="2" Padding="4,0">
                                    <StackPanel Orientation="Horizontal">
                                        <ContentPresenter Content="{Binding}" ContentTemplate="{Binding ElementName=root, Path=ItemTemplate}" TextBlock.Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"/>
                                        <Button Content="✕" Style="{DynamicResource MahApps.Styles.Button.Circle}" Background="{StaticResource BrushError}" Foreground="White"
                                                Width="20" Height="20" Margin="4,0,0,0"
                                                Command="{Binding ElementName=root, Path=RemoveItemCommand}" CommandParameter="{Binding}" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </Border>

        <!-- Popup Dropdown -->
        <Popup x:Name="PART_Popup" PlacementTarget="{Binding ElementName=root}" Placement="Bottom"
               Width="{Binding ActualWidth, ElementName=root}"
               IsOpen="{Binding IsPopupOpen, ElementName=root}" StaysOpen="False">
            <Border x:Name="PART_popupContent"
                    Background="{DynamicResource MahApps.Brushes.Window.Background}" Padding="4"
                    BorderBrush="{DynamicResource MahApps.Brushes.ComboBox.Border}" BorderThickness="1" CornerRadius="3" >
                <ScrollViewer MaxHeight="200">
                    <ItemsControl ItemsSource="{Binding ItemsSource, ElementName=root}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox x:Name="PART_PopupCheckbox" Checked="PART_PopupCheckbox_Checked" Unchecked="PART_PopupCheckbox_Unchecked"
                                          Foreground="{DynamicResource MahApps.Brushes.ComboBox.PopupForeground}">
                                    <CheckBox.IsChecked>
                                        <MultiBinding Mode="OneWay" Converter="{StaticResource SelectedItemsContainsConverter}">
                                            <Binding ElementName="root" Path="SelectedItems"/>
                                            <Binding Path="." />
                                        </MultiBinding>
                                    </CheckBox.IsChecked>
                                    <CheckBox.Content>
                                        <ContentPresenter Content="{Binding}" ContentTemplate="{Binding ElementName=root, Path=ItemTemplate}" />
                                    </CheckBox.Content>
                                </CheckBox>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Popup>
    </Grid>
</UserControl>
